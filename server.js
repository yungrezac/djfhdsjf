// --- –ù–ï–û–ë–•–û–î–ò–ú–´–ï –ë–ò–ë–õ–ò–û–¢–ï–ö–ò ---
// –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:
// npm install express node-telegram-bot-api

const express = require('express');
const TelegramBot = require('node-telegram-bot-api');

// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---

// –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞
const token = '8203577700:AAHBPcxw4y5kT4trl_bfZY4QRBQ99Q0S2E8';

// –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–±–µ–∑ @)
const botUsername = 'TerraRunbot';

// –í–ê–ñ–ù–û: –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å –ø—É–±–ª–∏—á–Ω—ã–π URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
// Telegram –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å.
// –ù–∞–ø—Ä–∏–º–µ—Ä: https://your-app-name.onrender.com –∏–ª–∏ IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
const serverUrl = 'https://djfhdsjf-8baf.vercel.app'; // <--- –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –ê–î–†–ï–°!

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ URL —Å–µ—Ä–≤–µ—Ä–∞ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω
if (serverUrl === 'https://YOUR_SERVER_URL_HERE') {
    console.error("-------------------------------------------------------------------");
    console.error("–û–®–ò–ë–ö–ê: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–º–µ–Ω–∏—Ç–µ 'https://YOUR_SERVER_URL_HERE' –Ω–∞");
    console.error("—Ä–µ–∞–ª—å–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –∫–æ–¥–µ.");
    console.error("-------------------------------------------------------------------");
    process.exit(1);
}

const bot = new TelegramBot(token);

// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–µ–±—Ö—É–∫. Telegram –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—é–¥–∞.
// –≠—Ç–æ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞, —á–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.
bot.setWebHook(`${serverUrl}/bot${token}`);

const app = express();
// Middleware –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON-—Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Telegram
app.use(express.json());

// --- –õ–û–ì–ò–ö–ê –ë–û–¢–ê ---

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const text = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TerraRun! –ì–æ—Ç–æ–≤—ã –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏?";

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤–∞—à–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Web App)
    const keyboard = {
        inline_keyboard: [
            [{
                text: 'üöÄ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –∏ –Ω–∞—á–∞—Ç—å!',
                // URL –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–ø—É—Å–∫–∞ –≤–∞—à–µ–≥–æ Web App –≤ Telegram
                web_app: { url: `https://t.me/${botUsername}/app` }
            }]
        ]
    };

    bot.sendMessage(chatId, text, {
        reply_markup: keyboard,
    });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram (—á–µ—Ä–µ–∑ –≤–µ–±—Ö—É–∫)
// Telegram –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å POST-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —ç—Ç–æ—Ç URL
app.post(`/bot${token}`, (req, res) => {
    bot.processUpdate(req.body);
    res.sendStatus(200); // –û—Ç–≤–µ—á–∞–µ–º Telegram, —á—Ç–æ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ
});


// --- API –î–õ–Ø –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –° –§–†–û–ù–¢–ï–ù–î–û–ú (–ü—Ä–∏–º–µ—Ä) ---
// –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
app.get('/api/health', (req, res) => {
    res.json({ status: 'ok', message: 'Server is running' });
});


// --- –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ---
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`–°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    console.log(`–í–µ–±—Ö—É–∫ –¥–ª—è –±–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞: ${serverUrl}/bot${token}`);
    console.log(`–í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: https://t.me/${botUsername}/app`);
});

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞ ---
bot.on('webhook_error', (error) => {
  console.error('Webhook Error:', error.code);  // –ù–∞–ø—Ä–∏–º–µ—Ä, 'EPARSE'
});

bot.on('polling_error', (error) => {
  console.error('Polling Error:', error.code); // –ù–∞–ø—Ä–∏–º–µ—Ä, 'EFATAL'
});
